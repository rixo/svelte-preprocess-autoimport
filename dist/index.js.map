{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import { parse, walk } from 'svelte/compiler'\n\nconst defaultConfig = {\n  aliases: {\n    onMount: 'svelte',\n    beforeUpdate: 'svelte',\n    afterUpdate: 'svelte',\n    onDestroy: 'svelte',\n    tick: 'svelte',\n    setContext: 'svelte',\n    getContext: 'svelte',\n    createEventDispatcher: 'svelte',\n\n    writable: 'svelte/store',\n    readable: 'svelte/store',\n    derived: 'svelte/store',\n    get: 'svelte/store',\n\n    tweened: 'svelte/motion',\n    spring: 'svelte/motion',\n\n    fade: 'svelte/transition',\n    blur: 'svelte/transition',\n    fly: 'svelte/transition',\n    slide: 'svelte/transition',\n    scale: 'svelte/transition',\n    draw: 'svelte/transition',\n\n    flip: 'svelte/animate',\n  },\n  createEventDispatcher: 'dispatch',\n}\n\nconst parseAlias = (x, as) =>\n  typeof x === 'string' ? { from: x, import: as, as } : { import: as, ...x, as }\n\nconst isDeclaration = (node, parent) => {\n  if (!parent) return false\n  switch (parent.type) {\n    case 'VariableDeclarator':\n      return true\n    case 'ImportDefaultSpecifier':\n    case 'ImportSpecifier':\n      return parent.local.name === node.name\n  }\n  return false\n}\n\nconst parseConfig = (arg = {}) => {\n  if (typeof arg === 'function') {\n    return arg(defaultConfig)\n  }\n  return {\n    ...defaultConfig,\n    ...arg,\n  }\n}\n\nconst trimStyle = code =>\n  code.replace(/<\\s*style[^>]*>[\\s\\S]*?<\\/\\s*style[^>]*>/g, x =>\n    x.replace(/./g, ' ')\n  )\n\nconst createPreprocessor = ({\n  aliases,\n  createEventDispatcher,\n} = defaultConfig) => ({\n  markup: async ({ content, filename }) => {\n    let code = content\n\n    // NOTE don't try to parse <style>\n    // there's nothing for us to be found in there, and it breaks with style\n    // preprocessors\n    // see: https://github.com/rixo/svelte-preprocess-autoimport/issues/2\n    const ast = parse(trimStyle(content))\n\n    const found = new Set()\n    const excluded = {}\n\n    const dispatches = []\n\n    walk(ast, {\n      enter(node, parent) {\n        switch (node.type) {\n          case 'Transition': // #4\n          case 'Animation':\n          case 'Identifier': {\n            const { name } = node\n            if (excluded[name]) break\n            if (isDeclaration(node, parent)) {\n              excluded[name] = true\n              break\n            }\n            if (createEventDispatcher && createEventDispatcher === name) {\n              dispatches.push(node)\n              break\n            }\n            if (aliases[name]) found.add(name)\n            break\n          }\n        }\n      },\n    })\n\n    const statements = []\n\n    const grouped = {}\n\n    if (dispatches.length > 0) {\n      grouped['svelte'] = [\n        'createEventDispatcher as ___spài_createEventDispatcher',\n      ]\n      const targetName = createEventDispatcher.replace(/^(\\$+)/, a =>\n        '_'.repeat(a.length)\n      )\n      for (const { start, end, name } of dispatches) {\n        code = code.slice(0, start) + targetName + code.slice(end)\n      }\n      statements.push(`const ${targetName} = ___spài_createEventDispatcher()`)\n    }\n\n    // aliases\n    if (found.size > 0) {\n      for (const alias of found) {\n        const { from, import: name, as } = parseAlias(aliases[alias], alias)\n        if (!grouped[from]) grouped[from] = []\n        grouped[from].push(name === as ? name : `${name} as ${as}`)\n      }\n    }\n\n    if (Object.keys(grouped).length > 0) {\n      statements.unshift(\n        Object.entries(grouped)\n          .map(\n            ([from, names]) =>\n              `import { ${names.sort().join(', ')} } from '${from}'`\n          )\n          .join('; ')\n      )\n    }\n\n    if (statements.length > 0) {\n      const target = ast.instance\n\n      const line = statements.join('; ') + ';'\n\n      if (target) {\n        code =\n          code.slice(0, target.content.start) +\n          line +\n          code.slice(target.content.start)\n      } else {\n        code = code + `\\n<script>${line}</script>`\n      }\n    }\n\n    return { code, map: null }\n  },\n})\n\nexport default config => createPreprocessor(parseConfig(config))\n"],"names":["parse","walk"],"mappings":"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"}